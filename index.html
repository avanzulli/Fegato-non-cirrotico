
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fegato non cirrotico — Diagnosi RM (v2)</title>
  <meta name="description" content="Helper diagnostico per lesioni focali epatiche in fegato non cirrotico basato su caratteristiche RM/MDCE e fase epatobiliare.">
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2a;
      --muted: #9fb0d1;
      --text: #eef3ff;
      --accent: #6ea8fe;
      --good: #2ecc71;
      --warn: #f1c40f;
      --bad: #e74c3c;
      --chip: #1f2b44;
      --border: #2a3a58;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1220 0%, #0e1423 100%);
      color: var(--text);
      line-height: 1.4;
    }
    header {
      padding: 20px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: rgba(11,18,32,0.75);
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 20px; letter-spacing: 0.2px; }
    header p { margin: 6px 0 0; color: var(--muted); font-size: 13px; }
    main { max-width: 1100px; margin: 0 auto; padding: 20px 16px 80px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 980px) {
      .grid { grid-template-columns: 1.2fr 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    .field { margin: 10px 0; }
    .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    select, input[type="number"], textarea {
      width: 100%;
      background: #0f1726;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip {
      padding: 6px 10px; border-radius: 999px; background: var(--chip); border: 1px solid var(--border);
      font-size: 12px; color: var(--muted);
    }
    .out { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #0f1726; padding: 12px; border-radius: 10px; border: 1px solid var(--border); }
    .bad { color: var(--bad); }
    .good { color: var(--good); }
    .warn { color: var(--warn); }
    .btnbar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      background: var(--accent);
      color: #091124;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    button.ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .list { margin: 0; padding-left: 18px; }
    .list li { margin: 6px 0; }
    footer { text-align: center; color: var(--muted); font-size: 12px; padding: 30px 0; }
    .pill { font-size: 11px; background: #0f1726; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 11px; padding: 2px 6px; border-radius: 6px; background: #0f1726; border: 1px solid var(--border); color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Fegato non cirrotico — Diagnosi RM (v2)</h1>
    <p>Helper interattivo per la caratterizzazione delle lesioni focali epatiche. Nessun dato inviato al server: tutto in locale.</p>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Caratteristiche RM</h2>

      <div class="row">
        <div class="field">
          <div class="label">Diametro massimo (mm)</div>
          <input id="size" type="number" min="1" step="1" placeholder="es. 18" />
        </div>
        <div class="field">
          <div class="label">Numero di lesioni</div>
          <select id="multiplicity">
            <option value="solitary">Singola</option>
            <option value="few">Oligo (&le;5)</option>
            <option value="many">Multiple diffuse</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <div class="label">Segnale T2</div>
          <select id="t2">
            <option value="low">Ipointenso</option>
            <option value="iso">Isointenso</option>
            <option value="mild-high">Iperintenso lieve/moderato</option>
            <option value="very-high">Iperintenso marcato ("light-bulb")</option>
            <option value="target">Segno a "target"</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Segnale T1 (in/opp-fat, pre-contrast)</div>
          <select id="t1">
            <option value="low">Ipointenso</option>
            <option value="iso">Isointenso</option>
            <option value="high">Iperintenso</option>
            <option value="fat">Presenza di grasso intralesionale</option>
            <option value="hemorrhage">Emorragia/proteine</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <div class="label">DWI/ADC</div>
          <select id="dwi">
            <option value="none">Nessuna restrizione</option>
            <option value="rim">Restrizione periferica ("rim")</option>
            <option value="marked">Restrizione marcata</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Pattern arterioso</div>
          <select id="arterial">
            <option value="none">Nessun enhancement</option>
            <option value="homogeneous">APHE omogeneo</option>
            <option value="peripheral-nodular">Nodulare periferico discontinuo</option>
            <option value="rim">Rim periferico</option>
            <option value="target">Target/periferia iper, centro ipo</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <div class="label">Evoluzione portale/tardiva</div>
          <select id="delay">
            <option value="washout">Washout</option>
            <option value="progressive-fill-in">Riempimento progressivo centripeto</option>
            <option value="persistent">Persistenza/isointensità</option>
            <option value="progressive-fibrous">Progressivo centrale (fibroso)</option>
            <option value="none">Nessun enhancement</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Capsula / retrazione capsulare</div>
          <select id="capsule">
            <option value="none">Assente</option>
            <option value="capsule">Capsula/enhancing rim liscia</option>
            <option value="retraction">Retr. capsulare/superficie concava</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <div class="label">Fase epatobiliare (gadoxetato)</div>
          <select id="hbp">
            <option value="unknown">Non eseguita</option>
            <option value="hyper">Iper/isointensa</option>
            <option value="hypo">Ipoinensa</option>
            <option value="target-hbp">Target (bordo ipo, centro iso/iper)</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Cicatrice centrale</div>
          <select id="scar">
            <option value="no">Assente</option>
            <option value="t2-bright-delayed">T2 iper + enhancement tardivo</option>
            <option value="t2-dark">T2 ipo/non tipica</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <div class="label">Contesto clinico</div>
          <select id="context">
            <option value="healthy">Fegato sano / no epatopatia</option>
            <option value="nafld">NAFLD/NASH</option>
            <option value="oncology">Paziente oncologico</option>
            <option value="ocp">F (>25 aa) con OCP</option>
            <option value="male">M giovane (<40 aa)</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Altri segni</div>
          <select id="misc">
            <option value="none">Nessuno</option>
            <option value="bile-ducts">Dilat. duttale/perilesionale</option>
            <option value="hemorrhage">Sangue/recenti emorragie</option>
            <option value="fat">Grasso intralesionale marcato</option>
          </select>
        </div>
      </div>

      <div class="btnbar">
        <button id="run">Suggerisci diagnosi</button>
        <button id="reset" class="ghost">Reset</button>
        <button id="export" class="ghost">Esporta JSON</button>
      </div>

      <div class="chips" id="activeChips"></div>
    </section>

    <section class="card">
      <h2>Output</h2>
      <div id="result" class="out" aria-live="polite">Inserisci le caratteristiche e premi “Suggerisci diagnosi”.</div>

      <h3 style="margin-top:16px;font-size:15px;">Differenziali principali</h3>
      <ul class="list" id="diffs"></ul>

      <h3 style="margin-top:16px;font-size:15px;">Note</h3>
      <div class="out" id="notes"></div>
    </section>
  </main>

  <footer>
    <span class="pill">v2 • Aggiornata per pattern RM di angioma, FNH, adenoma (subtipi), metastasi, ICC, EHE, PEComa, nodulo necrotico solitario, HCC (non cirrotico)</span>
  </footer>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const fields = ["size","multiplicity","t2","t1","dwi","arterial","delay","capsule","hbp","scar","context","misc"];
    const weights = {
      "Angioma": 0, "FNH": 0, "Adenoma": 0, "Metastasi": 0, "Colangiocarcinoma": 0,
      "HCC (non cirrotico)": 0, "EHE": 0, "PEComa": 0, "Nodulo necrotico solitario": 0, "Cisti semplice": 0
    };

    function chip(txt){ const s=document.createElement('span'); s.className='chip'; s.textContent=txt; return s; }
    function pushNote(s){ $("#notes").innerHTML += ( $("#notes").innerHTML ? "<br>" : "" ) + s; }

    function reset() {
      fields.forEach(id => {
        const el = $("#" + id);
        if (el.tagName === "SELECT") el.selectedIndex = 0;
        else el.value = "";
      });
      $("#result").textContent = "Inserisci le caratteristiche e premi “Suggerisci diagnosi”.";
      $("#diffs").innerHTML = "";
      $("#notes").textContent = "";
      $("#activeChips").innerHTML = "";
    }

    function exportJSON() {
      const data = {};
      fields.forEach(id => data[id] = $("#" + id).value);
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "lesione-epatica-RM.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function addChipFromSelections(){
      const chips = $("#activeChips");
      chips.innerHTML = "";
      fields.forEach(id => {
        const el = $("#" + id);
        const label = el.previousElementSibling?.textContent || id;
        const val = el.options ? el.options[el.selectedIndex].text : el.value;
        if (val && val !== "Non eseguita" && val !== "Assente" && val !== "Nessuno" && val !== "") {
          chips.appendChild(chip(label + ": " + val));
        }
      });
    }

    function score(){
      // Copy base weights
      const s = Object.assign({}, weights);
      const size = parseInt($("#size").value || "0", 10);
      const mult = $("#multiplicity").value;
      const t2 = $("#t2").value;
      const t1 = $("#t1").value;
      const dwi = $("#dwi").value;
      const art = $("#arterial").value;
      const del = $("#delay").value;
      const cap = $("#capsule").value;
      const hbp = $("#hbp").value;
      const scar = $("#scar").value;
      const ctx = $("#context").value;
      const misc = $("#misc").value;

      // Heuristics rooted in classic MR patterns
      // Cyst
      if (t2 === "very-high" && art === "none" && del === "none" && hbp !== "target-hbp" && dwi !== "marked") s["Cisti semplice"] += 7;

      // Hemangioma
      if (t2 === "very-high") s["Angioma"] += 3;
      if (art === "peripheral-nodular") s["Angioma"] += 4;
      if (del === "progressive-fill-in") s["Angioma"] += 4;
      if (del === "persistent") s["Angioma"] += 2;
      if (cap === "retraction") s["Angioma"] -= 2; // incongruo

      // FNH
      if (art === "homogeneous" && del === "persistent") s["FNH"] += 4;
      if (scar === "t2-bright-delayed") s["FNH"] += 4;
      if (hbp === "hyper") s["FNH"] += 5;
      if (hbp === "hypo") s["FNH"] -= 2;
      if (mult !== "solitary") s["FNH"] -= 1;

      // Adenoma (considering H-H, I-H, β-catenina, infiammatorio)
      if (ctx === "ocp" || t1 === "fat" || misc === "hemorrhage") s["Adenoma"] += 3;
      if (art === "homogeneous") s["Adenoma"] += 2;
      if (hbp === "hypo") s["Adenoma"] += 3;
      if (dwi === "none") s["Adenoma"] += 1;
      if (scar === "t2-bright-delayed") s["Adenoma"] -= 2; // contro FNH

      // Metastases
      if (mult !== "solitary") s["Metastasi"] += 3;
      if (art === "rim" || art === "target") s["Metastasi"] += 3;
      if (dwi !== "none") s["Metastasi"] += 2;
      if (hbp === "hypo" || hbp === "target-hbp") s["Metastasi"] += 2;

      // ICC
      if (cap === "retraction") s["Colangiocarcinoma"] += 4;
      if (art === "rim") s["Colangiocarcinoma"] += 2;
      if (del === "progressive-fibrous") s["Colangiocarcinoma"] += 4;
      if (t2 === "mild-high" || t2 === "target") s["Colangiocarcinoma"] += 1;
      if (misc === "bile-ducts") s["Colangiocarcinoma"] += 3;

      // HCC (rare in non-cirrhotic but possible)
      if (art === "homogeneous" && del === "washout") s["HCC (non cirrotico)"] += 3;
      if (cap === "capsule") s["HCC (non cirrotico)"] += 2;
      if (hbp === "hypo") s["HCC (non cirrotico)"] += 1;
      if (ctx === "nafld" || ctx === "male") s["HCC (non cirrotico)"] += 1;

      // EHE
      if (t2 === "target" || art === "target") s["EHE"] += 3;
      if (cap === "retraction") s["EHE"] += 2;
      if (del === "progressive-fibrous") s["EHE"] += 1;
      if (mult !== "solitary") s["EHE"] += 1;
      if (hbp === "hypo") s["EHE"] += 1;

      // PEComa
      if (t1 === "fat" && art === "homogeneous") s["PEComa"] += 3;
      if (art === "homogeneous" && del === "persistent") s["PEComa"] += 1;
      if (hbp === "hypo") s["PEComa"] += 1;

      // Solitary necrotic nodule (SNN)
      if (t1 === "low" && t2 === "iso" && dwi === "rim" && art === "none" && del === "none") s["Nodulo necrotico solitario"] += 4;
      if (size > 30) s["Nodulo necrotico solitario"] -= 1;

      // Size/multiplicity nuance
      if (size && size < 25 && s["Angioma"] > 0) s["Angioma"] += 1;
      if (size && size > 40 && del === "washout") s["HCC (non cirrotico)"] += 1;
      if (size && size > 30 && cap === "retraction") s["Colangiocarcinoma"] += 1;

      return s;
    }

    function rank(scores){
      const items = Object.entries(scores).map(([k,v]) => [k, v]);
      items.sort((a,b)=> b[1]-a[1]);
      // Normalize to 0..100 for display
      const max = Math.max(1, items[0][1]);
      return items.map(([k,v]) => [k, Math.round(100 * v / max)]);
    }

    function explain(top){
      const map = {
        "Angioma": "T2 molto alto, enhancement periferico nodulare con fill-in centripeto e persistenza tardiva.",
        "FNH": "APHE omogeneo, cicatrice T2 iper con enhancement tardivo, HBP iso/iper.",
        "Adenoma": "Donna con OCP, grasso/emorragia, APHE ±, HBP ipointensa.",
        "Metastasi": "Multiple, rim/target APHE, restrizione DWI, HBP ipo/target.",
        "Colangiocarcinoma": "Rim arterioso, progressivo fibroso, retrazione capsulare, possibili dilatazioni duttali.",
        "HCC (non cirrotico)": "APHE + washout + capsula; più raro in fegato sano/NAFLD.",
        "EHE": "Segno a target, noduli periferici coalescenti, retrazione capsulare, enhancement progressivo.",
        "PEComa": "APHE intenso, possibile grasso, HBP ipointensa.",
        "Nodulo necrotico solitario": "Assenza di enhancement, possibile rim DWI, contesto reattivo.",
        "Cisti semplice": "T2 altissimo, nessun enhancement, pareti sottili."
      };
      return map[top] || "";
    }

    function suggest(){
      addChipFromSelections();
      $("#notes").textContent = "";

      const sc = score();
      const ranked = rank(sc).filter(([_,p]) => p>0).slice(0,5);

      if (!ranked.length){
        $("#result").innerHTML = "<span class='warn'>Pattern non dirimente</span>: aggiungere fase epatobiliare o CEUS, oppure follow-up/biopsia secondo contesto clinico.";
        $("#diffs").innerHTML = "";
        pushNote("Questa è un'assistenza euristica, non una classificazione ufficiale. Usare giudizio clinico.");
        return;
      }

      const [topDx, topScore] = ranked[0];
      const msg = `<strong>Diagnosi suggerita:</strong> ${topDx} <span class="${topScore>70?'good':(topScore>40?'warn':'bad')}">(${topScore}%)</span>`;
      $("#result").innerHTML = msg + "<br>" + explain(topDx);

      const diffs = $("#diffs");
      diffs.innerHTML = "";
      ranked.slice(1).forEach(([k,p]) => {
        const li = document.createElement('li');
        li.innerHTML = `${k} — <span class="${p>60?'good':(p>35?'warn':'bad')}">${p}%</span>`;
        diffs.appendChild(li);
      });

      pushNote("Se HBP non eseguita: considerare gadoxetato per distinguere FNH (iso/iper) da adenoma/metastasi (ipo).");
      pushNote("Pattern di angioma richiesto: T2 'light-bulb' + nodulare periferico con fill-in centripeto.");
    }

    $("#run").addEventListener("click", suggest);
    $("#reset").addEventListener("click", reset);
    $("#export").addEventListener("click", exportJSON);
  </script>
</body>
</html>
